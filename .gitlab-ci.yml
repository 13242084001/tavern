---

variables:
  GIT_SUBMODULE_STRATEGY: none

stages:
- precheck
- quick-tests
- long-tests
- deploy


# Base script for tests
.basetest: &basetest
  stage: quick-tests
  cache:
    key: tavern-project-cache
    paths:
    - ./pip-cache/
    policy: pull

  before_script:
  - echo "install_command = pip install --cache-dir=./pip-cache/ {opts} {packages}" >> tox.ini
  - pip install --upgrade tox --cache-dir=./pip-cache/
  script:
  - tox -c ${TOXCFG} -e ${CI_JOB_NAME}

  variables:
    TOXCFG: tox.ini

# Different cfg file and needs docker running
.integrationtest: &inttest
  <<: *basetest
  stage: long-tests
  variables:
    TOXCFG: tox-integration.ini
    # DOCKER_HOST: tcp://docker:2375
  services:
  - docker:dind
  before_script:
  - pip3 install --upgrade docker-compose tox pip setuptools --cache-dir=./pip-cache/
  - mkdir -p /root/.docker/
  - touch /root/.docker/config.json
  - docker-compose --verbose -f ./tests/integration/docker-compose.yaml images
  - echo "install_command = pip install --cache-dir={toxinidir}/pip-cache/ {opts} {packages}" >> tox-integration.ini

########################################
# Initial checks
# Make sure there's nothing horrendously wrong first
########################################

py38black:
  <<: *basetest
  image: python:3.8-slim

py38:
  <<: *basetest
  image: python:3.8-slim

py38lint:
  <<: *basetest
  image: python:3.8-slim

py38isort:
  <<: *basetest
  image: python:3.8-slim

py38-generic:
  <<: *basetest
  image: python:3.8-slim

  # This one requires integration tox file
  variables:
    TOXCFG: tox-integration.ini

  # Make this job push the cache. It doesn't hugely matter if the cache is out
  # of date, so just do it in one job.
  cache:
    key: tavern-project-cache
    paths:
    - ./pip-cache/1

########################################
# Integration tests
########################################

pypy3-generic:
  <<: *inttest
  image: pypy:3-slim

py37-generic:
  <<: *inttest
  #  Override here
  image: python:3.7-slim

py38-mqtt:
  <<: *inttest
  image: python:3.8-slim

py38-hooks:
  <<: *inttest
  image: python:3.8-slim

py38-advanced:
  <<: *inttest
  image: python:3.8-slim
